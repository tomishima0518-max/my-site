<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ryuten Portal</title>

<style>
body{ font-family:sans-serif; background:#222; color:#fff; margin:0; padding:0;}
header{ display:flex; justify-content:center; background:#111; padding:10px;}
header button{ margin:0 5px; padding:5px 15px; background:#444; color:#fff; border:none; cursor:pointer;}
.activeTab{ background:red;}
#videoGrid{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:10px;}
.card{ background:#333; border-radius:10px; padding:10px; width:250px; position:relative;}
.card img{ width:100%; border-radius:10px;}
.danmakuLayer{ position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; overflow:hidden;}
.danmaku{ position:absolute; white-space:nowrap; color:#fff; font-weight:bold; text-shadow:1px 1px 2px #000;}
#videoModal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; flex-direction:column;}
#videoModal iframe{ width:800px; height:450px; margin-bottom:10px;}
#commentSection{ width:800px; max-height:150px; overflow-y:auto; background:#111; padding:10px; border-radius:5px;}
#commentSection p{ margin:2px 0;}
#nameInputContainer{ position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:flex; justify-content:center; align-items:center; flex-direction:column; z-index:1000;}
#nameInputContainer input{ padding:10px; font-size:16px; margin-bottom:10px; width:250px;}
#nameInputContainer button{ padding:10px 20px; font-size:16px;}
.channel-btn{ display:inline-block; padding:5px 10px; margin-top:5px; background:red; color:#fff; border:none; cursor:pointer; text-decoration:none;}
</style>
</head>
<body>

<!-- åå‰å…¥åŠ›ç”»é¢ -->
<div id="nameInputContainer">
  <h2>åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h2>
  <input type="text" id="userNameInput" placeholder="åå‰">
  <button id="startBtn">é–‹å§‹</button>
</div>

<header>
  <button class="tabBtn activeTab" data-tab="info">æƒ…å ±</button>
  <button class="tabBtn" data-tab="videos">å‹•ç”»ï¼†ã‚·ãƒ§ãƒ¼ãƒˆ</button>
  <button class="tabBtn" data-tab="other">ä»–</button>
</header>

<div id="contentArea">
  <div id="infoTab" class="tabContent">ã“ã‚“ã«ã¡ã¯ï¼ã‚µã‚¤ãƒˆã¸ã‚ˆã†ã“ãï¼</div>
  <div id="videosTab" class="tabContent" style="display:none;">
    <div id="videoGrid"></div>
  </div>
  <div id="otherTab" class="tabContent" style="display:none;">ãã®ä»–æƒ…å ±</div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«å‹•ç”»å†ç”Ÿ -->
<div id="videoModal">
  <iframe id="modalIframe" src="" frameborder="0" allowfullscreen></iframe>
  <div class="danmakuLayer" id="danmakuLayer"></div>
  <div id="commentSection"></div>
  <input type="text" id="danmakuInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›">
  <button id="danmakuSend">é€ä¿¡</button>
  <button id="closeModal">é–‰ã˜ã‚‹</button>
</div>

<!-- ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ² -->
<div style="text-align:center; margin:20px;">
  <div class="g-ytsubscribe" data-channelid="UCmZY34Ev1I5FIcDC5tdXeDg" data-layout="default" data-count="default"></div>
  <p>ã‚µã‚¤ãƒˆå†…ç™»éŒ²è€…æ•°: <span id="siteSubscribers">0</span></p>
</div>
<script src="https://apis.google.com/js/platform.js"></script>

<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, setDoc, collection, updateDoc, onSnapshot, getDoc, addDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCrywE11RwAJm5_MsUAkcZ_WQECJehcLRY",
  authDomain: "YOUR_FIREBASE_AUTHDOMAIN",
  projectId: "YOUR_FIREBASE_PROJECTID",
  storageBucket: "YOUR_FIREBASE_BUCKET",
  messagingSenderId: "YOUR_FIREBASE_MESSAGINGID",
  appId: "YOUR_FIREBASE_APPID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let userName, userId;

// åå‰å…¥åŠ›ç”»é¢
document.getElementById("startBtn").addEventListener("click", async ()=>{
  const nameInput = document.getElementById("userNameInput").value.trim();
  if(!nameInput) return alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
  userName = nameInput;
  userId = crypto.randomUUID();

  // Firestoreã«ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ 
  await setDoc(doc(db,"users",userId), {name:userName, subscribed:false, createdAt:serverTimestamp()});

  document.getElementById("nameInputContainer").style.display="none";
});

// ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
const tabBtns = document.querySelectorAll(".tabBtn");
tabBtns.forEach(btn=>{
  btn.addEventListener("click", ()=>{
    tabBtns.forEach(b=>b.classList.remove("activeTab"));
    btn.classList.add("activeTab");
    document.querySelectorAll(".tabContent").forEach(c=>c.style.display="none");
    document.getElementById(btn.dataset.tab+"Tab").style.display="block";
  });
});

// ãƒ€ãƒŸãƒ¼å‹•ç”»ãƒ‡ãƒ¼ã‚¿
const videosData = [
  {id:"d1", title:"ğŸ”¥ Roblox DOORS æœ€é€Ÿæ”»ç•¥ï¼", thumbnail:"https://picsum.photos/250/140?random=1", views:1234, likes:456},
  {id:"d2", title:"ğŸ‘€ ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‹ãƒ¥ãƒ¼ã‚¹é€Ÿå ±", thumbnail:"https://picsum.photos/250/140?random=2", views:2345, likes:123},
  {id:"d3", title:"ğŸ’¥ ç¥ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆè§£èª¬", thumbnail:"https://picsum.photos/250/140?random=3", views:3456, likes:789}
];

const videoGrid = document.getElementById("videoGrid");

videosData.forEach(video=>{
  const card = document.createElement("div");
  card.className = "card";
  card.innerHTML=`
    <img src="${video.thumbnail}">
    <h3>${video.title}</h3>
    <p>å†ç”Ÿå›æ•°: ${video.views.toLocaleString()} å› ï½œ ğŸ‘ ${video.likes.toLocaleString()}</p>
    <div id="commentsPreview-${video.id}"></div>
    <input type="text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›" id="commentInput-${video.id}">
    <button id="sendComment-${video.id}">é€ä¿¡</button>
    <a href="#" onclick="openModal('${video.id}')" class="button">â–¶ è¦‹ã‚‹</a>
  `;
  videoGrid.appendChild(card);

  // ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡
  document.getElementById(`sendComment-${video.id}`).addEventListener("click", async ()=>{
    const input = document.getElementById(`commentInput-${video.id}`);
    const text = input.value.trim();
    if(!text) return;
    const colRef = collection(db,"comments",video.id,"items");
    await addDoc(colRef,{name:userName,text:text,createdAt:serverTimestamp()});
    input.value="";
  });

  // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§
  const colRef = collection(db,"comments",video.id,"items");
  onSnapshot(colRef,snapshot=>{
    const preview = document.getElementById(`commentsPreview-${video.id}`);
    preview.innerHTML="";
    snapshot.docs.slice(-3).forEach(doc=>{
      const data = doc.data();
      preview.innerHTML+=`<p><b>${data.name}:</b> ${data.text}</p>`;
    });
  });
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«å†ç”Ÿ
const modal = document.getElementById("videoModal");
const iframe = document.getElementById("modalIframe");
const danmakuLayer = document.getElementById("danmakuLayer");
const commentSection = document.getElementById("commentSection");
const danmakuInput = document.getElementById("danmakuInput");
const danmakuSend = document.getElementById("danmakuSend");

window.openModal = function(videoId){
  modal.style.display="flex";
  iframe.src=`https://www.youtube.com/embed/${videoId}?autoplay=1`;

  // å¼¾å¹•ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º
  const colRef = collection(db,"comments",videoId,"items");
  onSnapshot(colRef,snapshot=>{
    commentSection.innerHTML="";
    snapshot.docChanges().forEach(change=>{
      if(change.type==="added"){
        const data = change.doc.data();
        showDanmaku(`${data.name}: ${data.text}`);
        commentSection.innerHTML+=`<p><b>${data.name}:</b> ${data.text}</p>`;
      }
    });
  });

  // é€ä¿¡ãƒœã‚¿ãƒ³
  danmakuSend.onclick = async ()=>{
    const text = danmakuInput.value.trim();
    if(!text) return;
    const colRef = collection(db,"comments",videoId,"items");
    await addDoc(colRef,{name:userName,text:text,createdAt:serverTimestamp()});
    danmakuInput.value="";
  };
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
document.getElementById("closeModal").addEventListener("click", ()=>{
  iframe.src="";
  modal.style.display="none";
  danmakuLayer.innerHTML="";
});

// å¼¾å¹•è¡¨ç¤ºé–¢æ•°
function showDanmaku(text){
  const span = document.createElement("span");
  span.className="danmaku";
  span.textContent=text;
  const y = Math.random()*(danmakuLayer.clientHeight-30);
  span.style.top=y+"px";
  span.style.left=danmakuLayer.clientWidth+"px";
  danmakuLayer.appendChild(span);
  const duration=8000+Math.random()*4000;
  const start=performance.now();
  function animate(time){
    const elapsed = time-start;
    const percent = elapsed/duration;
    if(percent<1){
      span.style.left=(danmakuLayer.clientWidth - percent*(danmakuLayer.clientWidth+span.clientWidth))+"px";
      requestAnimationFrame(animate);
    }else danmakuLayer.removeChild(span);
  }
  requestAnimationFrame(animate);
}

// ã‚µã‚¤ãƒˆå†…ç™»éŒ²è€…æ•°è¡¨ç¤º
const siteSubRef = doc(db,"stats","siteSubscribers");
onSnapshot(siteSubRef, doc=>{
  if(doc.exists()) document.getElementById("siteSubscribers").textContent=doc.data().count;
});
</script>
</body>
</html>
