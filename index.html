<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ryuten Portal</title>
<style>
body{ font-family:sans-serif; background:#222; color:#fff; margin:0; padding:0;}
header, .innerTabs{ display:flex; justify-content:center; background:#111; padding:10px;}
header button, .innerTabs button{ margin:0 5px; padding:5px 15px; background:#444; color:#fff; border:none; cursor:pointer;}
.activeTab{ background:red;}
#videoGrid{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; margin:10px;}
.card{ background:#333; border-radius:10px; padding:10px; width:250px; position:relative;}
.card img{ width:100%; border-radius:10px;}
.videoWrapper{ position:relative; width:100%; height:0; padding-bottom:56.25%; margin:0 auto;}
.videoWrapper iframe{ position:absolute; width:100%; height:100%; top:0; left:0;}
.danmakuLayer{ position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; overflow:hidden;}
.danmaku{ position:absolute; white-space:nowrap; color:#fff; font-weight:bold; text-shadow:1px 1px 2px #000;}
#videoModal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); justify-content:center; align-items:center; flex-direction:column; z-index:2000;}
#videoModal iframe{ width:800px; height:450px; margin-bottom:10px;}
#commentSection{ width:800px; max-height:150px; overflow-y:auto; background:#111; padding:10px; border-radius:5px;}
#commentSection p{ margin:2px 0;}
.channel-btn{ display:inline-block; padding:5px 10px; margin-top:5px; background:red; color:#fff; border:none; cursor:pointer; text-decoration:none;}
.innerTabContent{ display:none; margin:10px;}
</style>
</head>
<body>

<header>
  <button class="tabBtn activeTab" data-tab="info">æƒ…å ±</button>
  <button class="tabBtn" data-tab="videos">å‹•ç”»ï¼†ã‚·ãƒ§ãƒ¼ãƒˆ</button>
  <button class="tabBtn" data-tab="other">ä»–</button>
</header>

<div id="contentArea">
  <div id="infoTab" class="tabContent">ã“ã‚“ã«ã¡ã¯ï¼ã‚µã‚¤ãƒˆã¸ã‚ˆã†ã“ãï¼</div>
  
  <div id="videosTab" class="tabContent">
    <div class="innerTabs">
      <button class="innerTabBtn activeTab" data-inner="popular">äººæ°—é †</button>
      <button class="innerTabBtn" data-inner="latest">æœ€æ–°</button>
      <button class="innerTabBtn" data-inner="oldest">å¤ã„</button>
    </div>
    <div id="popular" class="innerTabContent"></div>
    <div id="latest" class="innerTabContent"></div>
    <div id="oldest" class="innerTabContent"></div>
  </div>

  <div id="otherTab" class="tabContent">ãã®ä»–æƒ…å ±</div>
</div>

<!-- ãƒ¢ãƒ¼ãƒ€ãƒ«å‹•ç”»å†ç”Ÿ -->
<div id="videoModal">
  <iframe id="modalIframe" src="" frameborder="0" allowfullscreen></iframe>
  <div class="danmakuLayer" id="danmakuLayer"></div>
  <div id="commentSection"></div>
  <input type="text" id="danmakuInput" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›">
  <button id="danmakuSend">é€ä¿¡</button>
  <button id="closeModal">é–‰ã˜ã‚‹</button>
</div>

<!-- ãƒãƒ£ãƒ³ãƒãƒ«ç™»éŒ² -->
<div style="text-align:center; margin:20px;">
  <div class="g-ytsubscribe" data-channelid="UCmZY34Ev1I5FIcDC5tdXeDg" data-layout="default" data-count="default"></div>
  <p>ã‚µã‚¤ãƒˆå†…ç™»éŒ²è€…æ•°: <span id="siteSubscribers">0</span></p>
  <button id="subscribeBtn">ç™»éŒ²</button>
  <button id="unsubscribeBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
</div>

<script src="https://apis.google.com/js/platform.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, setDoc, collection, addDoc, onSnapshot, serverTimestamp, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

// Firebase è¨­å®š
const firebaseConfig = {
  apiKey: "AIzaSyCrywE11RwAJm5_MsUAkcZ_WQECJehcLRY",
  authDomain: "YOUR_FIREBASE_AUTHDOMAIN",
  projectId: "YOUR_FIREBASE_PROJECTID",
  storageBucket: "YOUR_FIREBASE_STORAGEBUCKET",
  messagingSenderId: "YOUR_FIREBASE_MESSAGINGID",
  appId: "YOUR_FIREBASE_APPID"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// ãƒ¦ãƒ¼ã‚¶ãƒ¼åè‡ªå‹•ç”Ÿæˆ
const randomId=Math.floor(Math.random()*1000000).toString().padStart(6,"0");
let userName=`Player#abc${randomId}`;
const officialName="ãƒªãƒ¥ã‚¦ãƒ†ãƒ³"; // ä½œè€…å›ºå®š
let userId=crypto.randomUUID();

// ã‚¿ãƒ–åˆ‡æ›¿
document.querySelectorAll(".tabBtn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".tabBtn").forEach(b=>b.classList.remove("activeTab"));
    btn.classList.add("activeTab");
    document.querySelectorAll(".tabContent").forEach(c=>c.style.display="none");
    document.getElementById(btn.dataset.tab+"Tab").style.display="block";
  });
});
document.querySelectorAll(".innerTabBtn").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".innerTabBtn").forEach(b=>b.classList.remove("activeTab"));
    btn.classList.add("activeTab");
    document.querySelectorAll(".innerTabContent").forEach(c=>c.style.display="none");
    document.getElementById(btn.dataset.inner).style.display="block";
  });
});

// YouTube API
const API_KEY="AIzaSyCrywE11RwAJm5_MsUAkcZ_WQECJehcLRY";
const CHANNEL_ID="UCmZY34Ev1I5FIcDC5tdXeDg";
async function loadYouTubeVideos(){
  const searchUrl=`https://www.googleapis.com/youtube/v3/search?key=${API_KEY}&channelId=${CHANNEL_ID}&part=snippet&order=date&maxResults=10&type=video`;
  const searchRes=await fetch(searchUrl);
  const searchData=await searchRes.json();
  const videoIds=searchData.items.map(v=>v.id.videoId).join(",");
  const statsUrl=`https://www.googleapis.com/youtube/v3/videos?key=${API_KEY}&id=${videoIds}&part=statistics`;
  const statsRes=await fetch(statsUrl);
  const statsData=await statsRes.json();

  ["popular","latest","oldest"].forEach(cat=>{
    const container=document.getElementById(cat);
    container.innerHTML="";
    let videosSorted=[...searchData.items];
    if(cat==="popular") videosSorted.sort((a,b)=>parseInt(statsData.items.find(v=>v.id===b.id.videoId).statistics.viewCount)-parseInt(statsData.items.find(v=>v.id===a.id.videoId).statistics.viewCount));
    if(cat==="oldest") videosSorted.reverse();
    videosSorted.forEach((item,index)=>{
      const videoId=item.id.videoId;
      const title=item.snippet.title;
      const thumb=item.snippet.thumbnails.high.url;
      const views=statsData.items[index].statistics.viewCount;
      const likes=statsData.items[index].statistics.likeCount||0;
      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <div class="videoWrapper">
          <img src="${thumb}">
          <div class="danmakuLayer" id="danmakuLayer-${videoId}"></div>
        </div>
        <h3>${title}</h3>
        <p>å†ç”Ÿå›æ•°: ${Number(views).toLocaleString()} ï½œ ğŸ‘ ${Number(likes).toLocaleString()}</p>
        <div id="commentsPreview-${videoId}"></div>
        <input type="text" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›" id="commentInput-${videoId}">
        <button id="sendComment-${videoId}">é€ä¿¡</button>
        <button onclick="openModal('${videoId}')">â–¶ è¦‹ã‚‹</button>
      `;
      container.appendChild(card);

      // ã‚³ãƒ¡ãƒ³ãƒˆé€ä¿¡
      document.getElementById(`sendComment-${videoId}`).addEventListener("click", async()=>{
        const text=document.getElementById(`commentInput-${videoId}`).value.trim();
        if(!text) return;
        const colRef=collection(db,"comments",videoId,"items");
        await addDoc(colRef,{name:userName,text,createdAt:serverTimestamp()});
        document.getElementById(`commentInput-${videoId}`).value="";
      });

      // ã‚³ãƒ¡ãƒ³ãƒˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º
      const colRef=collection(db,"comments",videoId,"items");
      onSnapshot(colRef,snapshot=>{
        const preview=document.getElementById(`commentsPreview-${videoId}`);
        preview.innerHTML="";
        snapshot.docs.slice(-3).forEach(doc=>{
          const data=doc.data();
          preview.innerHTML+=`<p><b>${data.name}:</b> ${data.text}</p>`;
        });
      });
    });
  });
}

// ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‹å¼¾å¹•
const modal=document.getElementById("videoModal");
const iframe=document.getElementById("modalIframe");
const danmakuLayer=document.getElementById("danmakuLayer");
const commentSection=document.getElementById("commentSection");
const danmakuInput=document.getElementById("danmakuInput");
const danmakuSend=document.getElementById("danmakuSend");

window.openModal=async function(videoId){
  modal.style.display="flex";
  iframe.src=`https://www.youtube.com/embed/${videoId}?autoplay=1`;
  const colRef=collection(db,"comments",videoId,"items");
  onSnapshot(colRef,snapshot=>{
    commentSection.innerHTML="";
    snapshot.docChanges().forEach(change=>{
      if(change.type==="added"){
        const data=change.doc.data();
        showDanmaku(`${data.name}: ${data.text}`);
        commentSection.innerHTML+=`<p><b>${data.name}:</b> ${data.text}</p>`;
      }
    });
  });
  danmakuSend.onclick=async()=>{
    const text=danmakuInput.value.trim();
    if(!text) return;
    await addDoc(colRef,{name:userName,text,createdAt:serverTimestamp()});
    danmakuInput.value="";
  };
};

document.getElementById("closeModal").addEventListener("click",()=>{
  iframe.src="";
  modal.style.display="none";
  danmakuLayer.innerHTML="";
});

function showDanmaku(text){
  const span=document.createElement("span");
  span.className="danmaku";
  span.textContent=text;
  const y=Math.random()*(danmakuLayer.clientHeight-30);
  span.style.top=y+"px";
  span.style.left=danmakuLayer.clientWidth+"px";
  danmakuLayer.appendChild(span);
  const duration=8000+Math.random()*4000;
  const start=performance.now();
  function animate(time){
    const elapsed=time-start;
    const percent=elapsed/duration;
    if(percent<1){
      span.style.left=(danmakuLayer.clientWidth - percent*(danmakuLayer.clientWidth+span.clientWidth))+"px";
      requestAnimationFrame(animate);
    }else danmakuLayer.removeChild(span);
  }
  requestAnimationFrame(animate);
}

// ã‚µã‚¤ãƒˆå†…ç™»éŒ²è€…æ•°ç®¡ç†
const siteSubscribers=document.getElementById("siteSubscribers");
const subscribeBtn=document.getElementById("subscribeBtn");
const unsubscribeBtn=document.getElementById("unsubscribeBtn");

async function updateSubscribers(){
  const usersSnapshot=await getDocs(collection(db,"users"));
  let count=0;
  usersSnapshot.forEach(doc=>{
    if(doc.data().subscribed) count++;
  });
  siteSubscribers.textContent=count;
}

function initSubscribersUpdater(){
  setInterval(updateSubscribers,1000);
}

// åˆæœŸåŒ–
(async()=>{
  // Firebaseã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
  await setDoc(doc(db,"users",userId),{name:userName,subscribed:false,createdAt:serverTimestamp()});
  loadYouTubeVideos();
  initSubscribersUpdater();
})();

subscribeBtn.addEventListener("click", async()=>{
  await setDoc(doc(db,"users",userId),{name:userName,subscribed:true},{merge:true});
});
unsubscribeBtn.addEventListener("click", async()=>{
  await setDoc(doc(db,"users",userId),{name:userName,subscribed:false},{merge:true});
});
</script>
</body>
</html>
