<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>DOORSã‚²ãƒ¼ãƒ  Firebaseç‰ˆ</title>
<style>
body { margin:0; overflow:hidden; font-family:sans-serif; background:#000; color:#fff; }
#ui { position:absolute; top:10px; left:10px; z-index:10; }
#hpBar { width:300px; height:20px; background:#555; }
#hpFill { width:100%; height:100%; background:#0f0; }
#timerBar { width:300px; height:20px; background:#555; margin-top:5px; }
#timerFill { width:100%; height:100%; background:#0f0; }
#message { margin-top:10px; white-space:pre-line; }
#difficultyButtons button { margin-right:5px; padding:5px 10px; }
#rankDOORS { max-height:200px; overflow-y:auto; margin-top:10px; }
#myRankDOORS { margin-top:5px; }
</style>
</head>
<body>

<div id="ui">
  <div id="difficultyButtons">
    <button onclick="startGame('easy')">ç°¡å˜</button>
    <button onclick="startGame('normal')">æ™®é€š</button>
    <button onclick="startGame('hard')">ãƒãƒ¼ãƒ‰</button>
  </div>
  <div id="hpBar"><div id="hpFill"></div></div>
  <div id="timerBar"><div id="timerFill"></div></div>
  <div id="message"></div>
  <h4>ğŸ† DOORSãƒ©ãƒ³ã‚­ãƒ³ã‚°</h4>
  <div id="myRankDOORS"></div>
  <ol id="rankDOORS"></ol>
</div>

<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* =========================
   Firebase åˆæœŸåŒ–
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyXXXXX", // å›ã®APIã‚­ãƒ¼
  authDomain: "ryutengame.firebaseapp.com",
  databaseURL: "https://ryutengame-default-rtdb.firebaseio.com",
  projectId: "ryutengame",
  storageBucket: "ryutengame.appspot.com",
  messagingSenderId: "1234567890",
  appId: "1:1234567890:web:abcdef123456"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* =========================
   ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä¿å­˜ï¼å–å¾—
   ========================= */
function saveScoreDOORS(score){
  const name = localStorage.name || prompt("åå‰"); localStorage.name=name;
  db.ref('rankings/doors').push({name, score});
}
function getRankDOORS(){
  db.ref('rankings/doors').orderByChild('score').limitToLast(150).once('value', snapshot=>{
    const r=[]; snapshot.forEach(child=>r.push(child.val()));
    r.sort((a,b)=>b.score-a.score);
    const rankEl=document.getElementById('rankDOORS');
    const myRankEl=document.getElementById('myRankDOORS');
    rankEl.innerHTML="";
    r.forEach((d,i)=>{
      const li=document.createElement("li");
      li.textContent=`${i+1}ä½ ${d.name} : ${d.score}`;
      rankEl.appendChild(li);
      if(d.name===localStorage.name) myRankEl.textContent=`ã‚ãªãŸï¼š${i+1}ä½ï½œ${d.score}ãƒ‰ã‚¢`;
    });
  });
}

/* =========================
   Three.js DOORSã‚²ãƒ¼ãƒ 
   ========================= */
let scene, camera, renderer;
let playerHP = 300;
let currentDoor = 0;
let difficulty;
let timer = 0;
let timerMax = 0;
let timerInterval;

function startGame(mode){
  difficulty=mode;
  document.getElementById('difficultyButtons').style.display='none';
  currentDoor=0; playerHP=300;
  initScene();
  elevatorDrop();
}

// Three.jsåˆæœŸåŒ–
function initScene(){
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(0,1.6,5);
  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.body.appendChild(renderer.domElement);

  let floor = new THREE.Mesh(new THREE.BoxGeometry(10,0.1,10), new THREE.MeshBasicMaterial({color:0x333}));
  scene.add(floor);

  for(let i=0;i<3;i++){
    let door = new THREE.Mesh(new THREE.BoxGeometry(1,2,0.1), new THREE.MeshBasicMaterial({color:0x888}));
    door.position.set(i*3-3,1,0);
    door.name='door'+(i+1);
    scene.add(door);
  }

  animate();
}

function elevatorDrop(){
  let dropTime=0;
  let dropInterval=setInterval(()=>{
    camera.position.y -=0.02;
    dropTime+=0.02;
    if(dropTime>=5){
      clearInterval(dropInterval);
      postElevatorEffect();
    }
  },10);
}

function postElevatorEffect(){
  let message = document.getElementById('message');
  if(difficulty=='easy') message.innerText='ç°¡å˜ãƒ¢ãƒ¼ãƒ‰: ãƒšãƒŠãƒ«ãƒ†ã‚£ãªã—\n';
  else if(difficulty=='normal') message.innerText='æ™®é€šãƒ¢ãƒ¼ãƒ‰: ãƒ€ãƒ¡ãƒ¼ã‚¸35 & ãƒ‰ã‚¢12ã¾ã§ã‚¹ãƒ”ãƒ¼ãƒ‰5%ä½ä¸‹\n';
  else message.innerText='ãƒãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰: ãƒ€ãƒ¡ãƒ¼ã‚¸80 & ãƒ‰ã‚¢15ã¾ã§ã‚¹ãƒ”ãƒ¼ãƒ‰10%ä½ä¸‹\n';
  message.innerText += 'ãƒ‰ã‚¢1ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆï¼';
  startTimerAttack();
}

// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
function animate(){ requestAnimationFrame(animate); renderer.render(scene, camera); }

// HPæ›´æ–°
function updateHP(amount){
  playerHP = Math.max(0, playerHP+amount);
  document.getElementById('hpFill').style.width=(playerHP/300*100)+'%';
  if(playerHP<=0){
    document.getElementById('message').innerText=`ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ğŸ’€ æœ€çµ‚ã‚¹ã‚³ã‚¢ï¼š${currentDoor}`;
    clearInterval(timerInterval);
    saveScoreDOORS(currentDoor);
    getRankDOORS();
  }
}

// ã‚¿ã‚¤ãƒãƒ¼ã‚¢ã‚¿ãƒƒã‚¯
function startTimerAttack(){
  timerMax=(difficulty=='easy')?35:(difficulty=='normal')?25:20;
  timer=timerMax;
  timerInterval=setInterval(()=>{
    timer-=0.1;
    let pct = timer/timerMax*100;
    let fill = document.getElementById('timerFill');
    if(pct>60) fill.style.background='green';
    else if(pct>30) fill.style.background='yellow';
    else if(pct>10) fill.style.background='orange';
    else if(pct>0) fill.style.background='red';
    else {
      fill.style.background='gray';
      document.getElementById('message').innerText='â˜ ï¸ã‚¿ã‚¤ãƒãƒ¼ã‚¢ã‚¿ãƒƒã‚¯ãƒ€ãƒ¡ãƒ¼ã‚¸ç™ºç”Ÿ!';
      updateHP(-75);
      timer = timerMax;
    }
    fill.style.width=Math.max(0,pct)+'%';
  },100);
}

// ãƒ‰ã‚¢é€²ã‚€
document.addEventListener('keydown', (e)=>{
  if(e.key==='ArrowRight'){
    currentDoor++;
    document.getElementById('message').innerText=`ãƒ‰ã‚¢${currentDoor}ã«åˆ°é”ï¼`;
    saveScoreDOORS(currentDoor);
    getRankDOORS();
  }
});
</script>
</body>
</html>
